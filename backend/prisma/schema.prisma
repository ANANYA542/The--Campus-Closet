generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
enum UserRole {
  BUYER
  SELLER
  BOTH
}

model User {
  id               Int              @id @default(autoincrement())
  name             String
  email            String           @unique
  password         String
  urnId            String           @unique
  role             UserRole         @default(BOTH)
  avatarUrl        String?
  reputationScore  Int              @default(0)
  createdAt        DateTime         @default(now())
  verifyToken      String?
  emailVerified    Boolean          @default(false)

  address          Address?
  items            Item[]           @relation("UserItems")
  boughtItems      Transaction[]    @relation("BuyerTransactions")
  soldItems        Transaction[]    @relation("SellerTransactions")
  rentals          Rental[]         @relation("UserRentals")
  cartItems        CartItem[]
  reviews          Review[]
  wishlistItems    Wishlist[]
  notifications    Notification[]
  buyerConversations Conversation[] @relation("BuyerConversations")
  sellerConversations Conversation[] @relation("SellerConversations")
  sentMessages     Message[]        @relation("MessageSender")
}


model Address {
  id             Int    @id @default(autoincrement())
  userId         Int    @unique
  collegeName    String
  departmentName String
  hostelName     String
  roomNumber     String

  user           User   @relation(fields: [userId], references: [id])
}

model Item {
  id             Int          @id @default(autoincrement())
  name           String
  description    String       @db.Text
  category       String
  categoryId     Int?
  price          Float
  rentPrice      Float?
  condition      String
  isForRent      Boolean      @default(false)
  status         String       @default("available") // available, sold, rented
  images         Json?
  viewCount      Int          @default(0)
  stockQuantity  Int          @default(1)
  createdAt      DateTime     @default(now())

  owner          User         @relation("UserItems", fields: [ownerId], references: [id])
  ownerId        Int
  categoryRef    Category?    @relation(fields: [categoryId], references: [id])
  transactions   Transaction[]
  rentals        Rental[]
  cartItems      CartItem[]
  reviews        Review[]
  wishlistedBy   Wishlist[]
  conversations  Conversation[]
}

model Transaction {
  id            Int       @id @default(autoincrement())
  buyer         User      @relation("BuyerTransactions", fields: [buyerId], references: [id])
  buyerId       Int
  seller        User      @relation("SellerTransactions", fields: [sellerId], references: [id])
  sellerId      Int
  item          Item      @relation(fields: [itemId], references: [id])
  itemId        Int
  amount        Float
  paymentId     String?
  status        String    @default("pending") // pending, completed, cancelled
  createdAt     DateTime  @default(now())
}

model Rental {
  id            Int       @id @default(autoincrement())
  renter        User      @relation("UserRentals", fields: [renterId], references: [id])
  renterId      Int
  item          Item      @relation(fields: [itemId], references: [id])
  itemId        Int
  startDate     DateTime
  endDate       DateTime
  totalRent     Float
  deposit       Float
  status        String    @default("active") // active, returned, overdue
  createdAt     DateTime  @default(now())
}

model CartItem {
  id        Int      @id @default(autoincrement())
  userId    Int
  itemId    Int
  quantity  Int      @default(1)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  item Item @relation(fields: [itemId], references: [id])

  @@unique([userId, itemId])
}

model Review {
  id            Int       @id @default(autoincrement())
  user          User      @relation(fields: [userId], references: [id])
  userId        Int
  item          Item      @relation(fields: [itemId], references: [id])
  itemId        Int
  rating        Int
  comment       String
  createdAt     DateTime  @default(now())
}

model Notification {
  id            Int       @id @default(autoincrement())
  user          User      @relation(fields: [userId], references: [id])
  userId        Int
  message       String
  type          String
  isRead        Boolean   @default(false)
  createdAt     DateTime  @default(now())
}

model Conversation {
  id         Int       @id @default(autoincrement())
  buyer      User      @relation("BuyerConversations", fields: [buyerId], references: [id])
  buyerId    Int
  seller     User      @relation("SellerConversations", fields: [sellerId], references: [id])
  sellerId   Int
  item       Item?     @relation(fields: [itemId], references: [id])
  itemId     Int?
  messages   Message[]
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([buyerId, sellerId, itemId])
}

model Message {
  id             Int          @id @default(autoincrement())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId Int
  sender         User         @relation("MessageSender", fields: [senderId], references: [id])
  senderId       Int
  content        String
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())
}

model Wishlist {
  id        Int      @id @default(autoincrement())
  userId    Int
  itemId    Int
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  item Item @relation(fields: [itemId], references: [id])

  @@unique([userId, itemId])
}
model Category {
  id        Int     @id @default(autoincrement())
  name      String
  items     Item[]
  createdAt DateTime @default(now())
}